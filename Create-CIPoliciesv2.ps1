# Source from GitHUB# https://github.com/MicrosoftDocs/windows-itpro-docs/tree/public/windows/security/threat-protection/windows-defender-application-control#-----------------------------------------------------------------------------------------------------------# UMCI enabled -> AUDIT MODE$content=Invoke-WebRequest -UseBasicParsing -Uri https://raw.githubusercontent.com/MicrosoftDocs/windows-itpro-docs/master/windows/security/threat-protection/windows-defender-application-control/microsoft-recommended-block-rules.md#find start and end$XMLStart=$content.Content.IndexOf("<?xml version=")$XMLEnd=$content.Content.IndexOf("</SiPolicy>")+11 # 11 is lenght of string#create xml[xml]$XML=$content.Content.Substring($xmlstart,$XMLEnd-$XMLStart) #find XML part
($XML).Save("C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\Microsoft-recommended-block-rules.xml")#--> Before merge it, you can enable specific OS sections inside the XML, 2 sections to uncomment#Create mergedPolicy$AllowMicrosoft = "C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\AllowMicrosoft.xml"$RecommendedBlockRules = "C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\Microsoft-recommended-block-rules.xml"$Cipolicy = "C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\AllowMicrosoft_DenyByPassApps_Audit.xml"$mergedPolicyRules = Merge-CIPolicy -PolicyPaths $AllowMicrosoft,$RecommendedBlockRules -OutputFilePath $CipolicySet-RuleOption -FilePath $cipolicy -Option 3#Set-RuleOption -FilePath $cipolicy -Option 16 -Delete #Just for WS2016Set-HVCIOptions -FilePath $Cipolicy -Enabled#Setting Metadata#Set-CIPolicyIdInfo $Cipolicy -ResetPolicyID # not compatible with WS2016/WS2019, CI needs PolicyTypeID after some tests.Set-CIPolicyVersion -FilePath $Cipolicy -Version '1.0.0'Set-CIPolicyIdInfo -FilePath $Cipolicy -PolicyId "AllowMicrosoft_DenyByPassApps_Audit_20200303" -PolicyName "AllowMicrosoft_DenyByPassApps_Audit"ConvertFrom-CIPolicy -XmlFilePath $cipolicy -BinaryFilePath "$cipolicy.bin"# WARNING: "Warning: Please use new policy format which has PolicyID and BasePolicyID, but no PolicyTypeID. You can use -MultiplePolicyFormat with New-CIPolicy or use -Reset with Set-CIPolicyIdInfo# Examples policies do not have PolicyTypeID, Recommended Blocked Rules policy does HAVE PolicyTypeID.#-----------------------------------------------------------------------------------------------------------#UMCI disabled & Driver blocked rules merge -> AUDIT MODE#Blocked Drivers:$content=Invoke-WebRequest -UseBasicParsing -Uri https://raw.githubusercontent.com/MicrosoftDocs/windows-itpro-docs/public/windows/security/threat-protection/windows-defender-application-control/microsoft-recommended-driver-block-rules.md #find start and end $XMLStart=$content.Content.IndexOf("<?xml version=")$XMLEnd=$content.Content.IndexOf("</SiPolicy>")+11 # 11 is length of string#create xml[xml]$XML=$content.Content.Substring($xmlstart,$XMLEnd-$XMLStart) #find XML part($XML).Save("C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\Microsoft-recommended-driver-block-rules.xml")#Create mergedPolicy$AllowMicrosoft = "C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\AllowMicrosoft.xml"$RecommendedDriverBlockRules = "C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\Microsoft-recommended-driver-block-rules.xml"$Cipolicy = "C:\Software\MS\Virtualization\ShieldedVMs\CI Policies\AllowMicrosoft_DenyDrivers_Audit.xml"$mergedPolicyRules = Merge-CIPolicy -PolicyPaths $AllowMicrosoft,$RecommendedDriverBlockRules -OutputFilePath $CipolicySet-RuleOption -FilePath $cipolicy -Option 0 -DeleteSet-RuleOption -FilePath $cipolicy -Option 3#Set-RuleOption -FilePath $cipolicy -Option 16 -Delete #Just for WS2016Set-HVCIOptions -FilePath $Cipolicy -Enabled#Setting Metadata#Set-CIPolicyIdInfo $Cipolicy -ResetPolicyID # not compatible with WS2016/WS2019, CI needs PolicyTypeID after some tests.Set-CIPolicyVersion -FilePath $Cipolicy -Version '1.0.0'Set-CIPolicyIdInfo -FilePath $Cipolicy -PolicyId "AllowMicrosoft_DenyDrivers_Audit_20201117" -PolicyName "AllowMicrosoft_DenyDrivers_Audit"ConvertFrom-CIPolicy -XmlFilePath $cipolicy -BinaryFilePath "$cipolicy.bin"# WARNING: "Warning: Please use new policy format which has PolicyID and BasePolicyID, but no PolicyTypeID. You can use -MultiplePolicyFormat with New-CIPolicy or use -Reset with Set-CIPolicyIdInfo# Examples policies do not have PolicyTypeID, Recommended Blocked Rules policy does HAVE PolicyTypeID. 